{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block content %}
<!-- Contenido específico de la página de dashboard -->
<div class="content-header">
</div>
<div class="content">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h3 class="m-0">Fichas Medicas</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item active">Dashboard</li>
        </ol>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <!-- Pestañas (Tabs) -->
        <div class="card">
          <div class="card-header p-0">
            <ul class="nav nav-pills">
              <li class="nav-item">
                <a class="nav-link" id="tabSeleccion" data-toggle="pill" href="#seleccion"
                  onclick="volverASeleccion()">Seleccionar opciones</a>

              </li>
              <li class="nav-item">
                <a class="nav-link" id="tabTabla" data-toggle="pill" href="#miTabla">Tabla</a>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="tab-content">
              <!-- Contenido de la pestaña de selección -->
              <div id="seleccion" class="tab-pane fade show active">
                <label for="opcionesSelect">Selecciona una opción:</label>
                <select class="form-control select2 form-control-sm" style="width: 100%;" id="codigo_paciente"
                  name="codigo_paciente">
                  <option value="">Buscar Paciente</option>
                  {% for item in data %}
                  <option value="{{ item.codprovcli }}">{{ item.codprovcli }} - {{ item.nombre }}</option>
                  {% endfor %}
                </select>

                <button type="button" class="btn btn-primary mt-2" onclick="seleccionarOpcion()">Continuar</button>
              </div>

              <!-- Contenido de la pestaña de la tabla -->
              <div id="miTabla" class="tab-pane fade">
                <!-- Contenido de la tabla -->
                <div class="table-responsive">

                  <table class="table">
                    <thead>
                      <tr>
                        <th class="text-sm">Ficha</th>
                        <th class="text-sm">Cedula</th>
                        <th class="text-sm">Historia</th>
                        <th class="text-sm">Paciente</th>
                        <th class="text-sm">Dirección</th>
                        <th class="text-sm">Teléfono</th>
                        <th class="text-sm">Acciones</th>
                        <!-- Agrega más columnas según sea necesario -->
                      </tr>
                    </thead>
                    <tbody>

                    </tbody>
                  </table>
                </div>
                <!-- /.table -->
              </div>
            </div>
          </div>
        </div>
        <!-- Fin de Pestañas (Tabs) -->
      </div>
    </div>

    <!-- MODAL PRINCIPAL -->
    <div class="modal fade" data-backdrop="static" id="modalInfoPaciente" tabindex="-1" role="dialog"
      aria-labelledby="modalInfoPacienteLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalInfoPacienteLabel">Detalles del Paciente</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- BARRA DE NAVEGACION DE PASOS Y FORMULARIO DE INFORMACION PRINCIPAL -->
            <div class="row g-1">
              <div class="col-md-12">

                <!-- Barra de navegación -->
                <ul class="nav nav-pills">
                  <li class="nav-item">
                    <a class="nav-link active paso-tab" data-toggle="pill" href="#paso1">Personal</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link paso-tab" data-toggle="pill" href="#paso2" disabled>Paso 2</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link paso-tab" data-toggle="pill" href="#paso3" disabled>Paso 3</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link paso-tab" data-toggle="pill" href="#paso4" disabled>Paso 4</a>
                  </li>
                </ul>

                <!-- CONTENIDO DEL FORMULARIO DE INFORMACION PERSONAL -->
                <div class="tab-content mt-2">
                  <!-- Paso 1 DATOS PERSONALES CARGADOS DESDE EL API -->
                  <div class="tab-pane fade show active" id="paso1">
                    <br>
                      <form id="datosEmpresaForm" method="get" action="{% url 'tu_vista_de_impresion' %}">
                        {% csrf_token %}
                    <div class="card card-primary">
                      <div class="card-header">
                        <h4 class="card-title">Datos del establecimiento - Empresa y Usuario</h4>
                      </div>
                      <div class="card-body">
                        <div class="row g-1">
                          <div class="col-md-12">
                            <div class="form-group">
                              <label for="inputNombreEmpresaVacuna">Intitución del Sistema o Nombre de la
                                Empresa</label>
                              <input type="text" class="form-control" id="inputNombreEmpresaVacuna" name="empresa" disabled>
                            </div>
                          </div>
                        </div>
                        <div class="row g-1">
                          <div class="col-md-3">
                            <div class="form-group">
                              <label for="inputRucVacuna">RUC</label>
                              <input type="text" class="form-control" id="inputRucVacuna" name="ruc" disabled>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-group">
                              <label for="inputCiuuVacuna">CIUU</label>
                              <input type="text" class="form-control" id="inputCiuuVacuna" name="ciuu" disabled>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="inputEstablecimientoVacuna">Establecimiento de Salud</label>
                              <input type="text" class="form-control" id="inputEstablecimientoVacuna" name="establecimientosalud" disabled>
                            </div>
                          </div>
                        </div>
                        <div class="row g-1">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="inputNumHistoriaClinicaVacuna">Número de Historia Clínica</label>
                              <input type="number" class="form-control" id="inputNumHistoriaClinicaVacuna" name="historiaclinica" disabled>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="inputNumArchivoVacuna">Número de Archivo</label>
                              <input type="number" class="form-control" id="inputNumArchivoVacuna"  name="numarchivo" disabled>
                            </div>
                          </div>
                        </div>
                        <div class="row g-1">
                          <div class="col-md-3">
                            <div class="form-group">
                              <label for="inputPrimerApellidoVacuna">Primer Apellido</label>
                              <input type="text" class="form-control" id="inputPrimerApellidoVacuna"  name="pmerapellido" disabled>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-group">
                              <label for="inputSegundoApellidoVacuna">Segundo Apellido</label>
                              <input type="text" class="form-control" id="inputSegundoApellidoVacuna" name="segapellido" disabled>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-group">
                              <label for="inputPrimerNombreVacuna">Primer Nombre</label>
                              <input type="text" class="form-control" id="inputPrimerNombreVacuna" name="pmernombre" disabled>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-group">
                              <label for="inputSegundoNombreVacuna">Segundo Nombre</label>
                              <input type="text" class="form-control" id="inputSegundoNombreVacuna" name="segnombre" disabled>
                            </div>
                          </div>
                        </div>
                        <div class="row g-1">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="inputSexoVacuna">Sexo</label>
                              <input type="text" class="form-control" id="inputSexoVacuna"  name="sexo" disabled>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="inputCargoOcupacionVacuna">Cargo/Ocupación</label>
                              <input type="text" class="form-control" id="inputCargoOcupacionVacuna" name="ocupacion" disabled>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <button type="button" class="btn btn-primary next-button" data-toggle="pill"
                      href="#paso2">Siguiente</button>
                    </form>
                  </div>
                  <!-- Paso 2 -->
                  <div class="tab-pane fade" id="paso2">
                    <br>
                    <div class="card card-primary">
                      <div class="card-header">
                        <h4 class="card-title">Inmunizaciones</h4>
                      </div>
                      <div class="card-body">
                        <!-- LISTA DE VACUNAS -->
                        <div class="accordion" id="accordionListInmunizaciones">
                          <div class="card">
                            <div class="card-header" id="tetanosDifteriaItem">
                              <h2 class="mb-0">
                                <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse"
                                  data-target="#coleccionTetanos" aria-expanded="true" aria-controls="coleccionTetanos">
                                  Tetanos - Difteria
                                </button>
                              </h2>
                            </div>
                            <div id="coleccionTetanos" class="collapse show" aria-labelledby="tetanosDifteriaItem"
                              data-parent="#accordionListInmunizaciones">
                              <div class="card-body">

                                <!-- CONTENIDO CON UN FORMULARIO -->
                                <div class="table-responsive">
                                  <table class="table table-primary" id="tableTetanos">
                                    <thead>
                                      <tr>
                                        <th scope="col">Acciones</th>
                                        <th scope="col">Dosis</th>
                                        <th scope="col">Fecha</th>
                                        <th scope="col">Lote</th>
                                        <th scope="col">Esquema Completo</th>
                                        <th scope="col">Responsable de la Vacuna</th>
                                        <th scope="col">Establecimiento de Salud donde se colocó la Vacuna</th>
                                        <th scope="col">Observaciones</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr id="newRow">
                                        <td><button class="btn btn-success" id="btnAgregarFilaTetanos"
                                            onclick="agregarFila()">Agregar</button>
                                        </td>
                                        <td><span id="dosisSpan">1</span></td>
                                        <td><input type="date" id="fechaInput" placeholder="Fecha"></td>
                                        <td><input type="number" id="loteInput" placeholder="Lote"></td>
                                        <td><input type="checkbox" id="esquemaInput" placeholder="Esquema"></td>
                                        <td><input type="text" id="responsableInput" placeholder="Responsable"></td>
                                        <td><input type="text" id="establecimientoInput" placeholder="Establecimiento">
                                        </td>
                                        <td><input type="text" id="observacionesInput" placeholder="Observaciones"></td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="card">
                            <div class="card-header" id="hepatitisA">
                              <h2 class="mb-0">
                                <button class="btn btn-link btn-block text-left collapsed" type="button"
                                  data-toggle="collapse" data-target="#coleccionHepatitisA" aria-expanded="false"
                                  aria-controls="coleccionHepatitisA">
                                  Hepatitis A
                                </button>
                              </h2>
                            </div>
                            <div id="coleccionHepatitisA" class="collapse" aria-labelledby="hepatitisA"
                              data-parent="#accordionListInmunizaciones">
                              <div class="card-body">
                                Some placeholder content for the second accordion panel. This panel is hidden by
                                default.
                              </div>
                            </div>
                          </div>
                          <div class="card">
                            <div class="card-header" id="hepatitisB">
                              <h2 class="mb-0">
                                <button class="btn btn-link btn-block text-left collapsed" type="button"
                                  data-toggle="collapse" data-target="#coleccionHepatitisB" aria-expanded="false"
                                  aria-controls="coleccionHepatitisB">
                                  Hepatitis B
                                </button>
                              </h2>
                            </div>
                            <div id="coleccionHepatitisB" class="collapse" aria-labelledby="hepatitisB"
                              data-parent="#accordionListInmunizaciones">
                              <div class="card-body">
                                And lastly, the placeholder content for the third and final accordion panel. This panel
                                is hidden by default.
                              </div>
                            </div>
                          </div>
                          <div class="card">
                            <div class="card-header" id="influenza">
                              <h2 class="mb-0">
                                <button class="btn btn-link btn-block text-left collapsed" type="button"
                                  data-toggle="collapse" data-target="#coleccionInfluenza" aria-expanded="false"
                                  aria-controls="coleccionInfluenza">
                                  Influenza
                                </button>
                              </h2>
                            </div>
                            <div id="coleccionInfluenza" class="collapse" aria-labelledby="Influenza"
                              data-parent="#accordionListInmunizaciones">
                              <div class="card-body">
                                And lastly, the placeholder content for the third and final accordion panel. This panel
                                is hidden by default.
                              </div>
                            </div>
                          </div>
                          <div class="card">
                            <div class="card-header" id="fiebreAmarilla">
                              <h2 class="mb-0">
                                <button class="btn btn-link btn-block text-left collapsed" type="button"
                                  data-toggle="collapse" data-target="#coleccionFiebreAmarilla" aria-expanded="false"
                                  aria-controls="coleccionFiebreAmarilla">
                                  Fiebre Amarilla
                                </button>
                              </h2>
                            </div>
                            <div id="coleccionFiebreAmarilla" class="collapse" aria-labelledby="FiebreAmarilla"
                              data-parent="#accordionListInmunizaciones">
                              <div class="card-body">
                                And lastly, the placeholder content for the third and final accordion panel. This panel
                                is hidden by default.
                              </div>
                            </div>
                          </div>
                          <div class="card">
                            <div class="card-header" id="sarampionRubeola">
                              <h2 class="mb-0">
                                <button class="btn btn-link btn-block text-left collapsed" type="button"
                                  data-toggle="collapse" data-target="#coleccionSarampionRubeola" aria-expanded="false"
                                  aria-controls="coleccionSarampionRubeola">
                                  Sarampión - Rubeola
                                </button>
                              </h2>
                            </div>
                            <div id="coleccionSarampionRubeola" class="collapse" aria-labelledby="SarampionRubeola"
                              data-parent="#accordionListInmunizaciones">
                              <div class="card-body">
                                And lastly, the placeholder content for the third and final accordion panel. This panel
                                is hidden by default.
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <button type="button" class="btn btn-secondary prev-button" data-toggle="pill"
                      href="#paso1">Anterior</button>
                    <button type="button" class="btn btn-primary next-button" data-toggle="pill"
                      href="#paso3">Siguiente</button>
                  </div>
                  <!-- Paso 3 -->
                  <div class="tab-pane fade" id="paso3">
                    <br>
                    <h4>Paso 3</h4>
                    <form>
                      <div class="form-group">
                        <label for="edad">Edad:</label>
                        <input type="number" class="form-control" id="edad" placeholder="Ingrese su edad">
                      </div>
                      <button type="button" class="btn btn-secondary prev-button" data-toggle="pill"
                        href="#paso2">Anterior</button>
                      <button type="button" class="btn btn-primary next-button" data-toggle="pill"
                        href="#paso4">Siguiente</button>
                    </form>
                  </div>
                  <!-- Paso 4 -->
                  <div class="tab-pane fade" id="paso4">
                    <br>
                    <h4>Paso 4</h4>
                    <form>
                      <div class="form-group">
                        <label for="correo">Correo:</label>
                        <input type="email" class="form-control" id="correo" placeholder="Ingrese su correo">
                      </div>
                      <button type="button" class="btn btn-secondary prev-button" data-toggle="pill"
                        href="#paso3">Anterior</button>
                      <button type="submit" class="btn btn-success">Enviar</button>
                    </form>
                  </div>
                </div>

              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
              <button id="btnGrabar" type="button" class="btn btn-secondary" >Grabar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


<script>
  // Agregar funcionalidad para cambiar de pestaña al hacer clic en el botón "Siguiente"
  $(document).ready(function () {
    $('.next-button').on('click', function () {
      var nextTab = $(this).attr('href');
      $('.nav-pills a[href="' + nextTab + '"]').tab('show');
    });

    // Agregar funcionalidad para cambiar de pestaña al hacer clic en el botón "Anterior"
    $('.prev-button').on('click', function () {
      var prevTab = $(this).attr('href');
      $('.nav-pills a[href="' + prevTab + '"]').tab('show');
    });

    $('.paso-tab').on('click', function () {
      var targetTab = $(this).attr('href');
      $('.nav-pills a[href="' + targetTab + '"]').tab('show');
    });
  });

  function seleccionarOpcion() {
    var codprovcli = $('#codigo_paciente').val();

    if (codprovcli) {
      $.ajax({
        type: 'GET',
        url: '{% url "obtener_datos_paciente" %}',
        data: { 'codprovcli': codprovcli },
        success: function (data) {
          if (data.error) {
            alert(data.error);
          } else {
            var tabla = $('#miTabla tbody');
            tabla.empty();

            for (var i = 0; i < data.data.length; i++) {
              var paciente = data.data[i];
              var row = '<tr>';
              row += '<td class="text-sm">' + paciente.codprovcli + '</td>';
              row += '<td class="text-sm">' + paciente.historia + '</td>';
              row += '<td class="text-sm">' + paciente.ruc + '</td>';
              row += '<td class="text-sm">' + paciente.nombre + '</td>';
              row += '<td class="text-sm">' + paciente.direccion + '</td>';
              row += '<td class="text-sm">' + paciente.telefono + '</td>';
              if (paciente.bandactivo) {
                row += '<td><button class="btn btn-outline-secondary" onclick="capturarCodProvCli(\'' + paciente.codprovcli + '\', \'' + paciente.nombre + '\')">Activo</button></td>';
              } else {
                row += '<td><button class="btn btn-outline-secondary"  id="nazi" onclick="capturarCodProvCli(\'' + paciente.codprovcli + '\', \'' + paciente.nombre + '\')" disabled>Inactivo</button></td>';
              };
              row += '</tr>';
              tabla.append(row);
            }

            $('#tabSeleccion').removeClass('active');
            $('#tabTabla').addClass('active');
            $('#seleccion').removeClass('show active');
            $('#miTabla').addClass('show active');
          }
        },
        error: function () {
          alert('Error al obtener los datos del paciente');
        }
      });
    } else {
      alert('Por favor, selecciona un paciente.');
    }
  }

  function volverASeleccion() {
    $('#miTabla tbody').empty();
    $('#codigo_paciente').val('').trigger('change');
    $('#tabTabla').removeClass('active');
    $('#tabSeleccion').addClass('active');
    $('#miTabla').removeClass('show active');
    $('#seleccion').addClass('show active');
  }





  // Nueva función para capturar el valor y mostrarlo en la consola
  function capturarCodProvCli(codprovcli, paciente) {
    // Muestra los detalles en el modal
    $('#modalInfoPaciente').modal('show');

  }

</script>


<script>

    var empresa = {};
    // Nueva función para enviar datos usando Ajax
    function enviarDatos(empresa) {
        // Limpiar la variable datosFilas
        var datosFilas = '';
        console.log('datosFilas',datosFilas)
          // Actualiza el valor de vacuna_tetano
        var hayDatosEnTabla = datosTetanos.length > 0;
        var vacuna_tetano = hayDatosEnTabla ? 'Recibida' : '';
        // Guarda los datos de las filas
        if (hayDatosEnTabla) {
            datosFilas = JSON.stringify(datosTetanos);
            console.log('datosFilas2',datosFilas)
            // Reinicia el array de datosTetanos para evitar duplicados
            datosTetanos = [];
        }

    $.ajax({
      type: 'GET',
      url: '{% url "tu_vista_de_impresion" %}',
      data: {
        'nombre_empresa_vacuna': empresa.Nombreempresa,
        'ruc': empresa.Ruc,
        'historiaclinica' :empresa.HistoriaClinica,
        'primerapellido': empresa.PrimerApellido,
        'segundoapellido': empresa.SegundoApellido,
        'primernombre': empresa.PrimerNombre,
        'segundonombre': empresa.SegundoNombre,
        'sexo': empresa.Sexo,
        'ocupacion' : empresa.Ocupacion,
          'vacuna_tetano': vacuna_tetano,
          'datos_filas': datosFilas

        // Puedes agregar más datos si es necesario
      },
      success: function (response) {
        console.log(response);
        toastr.success('Insert a Vacunacion exitoso.', 'Éxito', {
            progressBar: true,
            closeDuration: 25,
          "positionClass": "toast-top-left",
        }); // Maneja la respuesta del servidor
      },
      error: function (error) {
        console.error('Error en la solicitud Ajax:', error);
      }
    });


      // Limpia los campos dentro de la tabla después de grabar
      limpiarCamposTabla();


  }

// Función para limpiar campos dentro de la tabla
function limpiarCamposTabla() {
  const tbody = document.getElementById('tableTetanos').getElementsByTagName('tbody')[0];
  const filas = tbody.getElementsByTagName('tr');

  // Itera sobre todas las filas excepto la primera
  for (let i = filas.length - 1; i > 0; i--) {
    tbody.removeChild(filas[i]);
  }

  // Reinicia el contador de dosis
  contadorDosis = 1;

  // Actualiza el contenido de la celda de dosis en la primera fila con los inputs
  const dosisSpan = document.getElementById('dosisSpan');
  dosisSpan.textContent = contadorDosis;

  // Habilita el botón de agregar
  document.getElementById('btnAgregarFilaTetanos').disabled = false;
}

  $(document).ready(function () {
    // DECLARACION DE LOS INPUTS PARA LLENAR
    const inputRucVacuna = document.getElementById('inputRucVacuna');
    const inputNombreEmpresaVacuna = document.getElementById('inputNombreEmpresaVacuna');
    const inputNumHistoriaClinicaVacuna = document.getElementById('inputNumHistoriaClinicaVacuna');
    const inputCargoOcupacionVacuna = document.getElementById('inputCargoOcupacionVacuna');
    const inputPrimerApellidoVacuna = document.getElementById('inputPrimerApellidoVacuna');
    const inputSegundoApellidoVacuna = document.getElementById('inputSegundoApellidoVacuna');
    const inputPrimerNombreVacuna = document.getElementById('inputPrimerNombreVacuna');
    const inputSegundoNombreVacuna = document.getElementById('inputSegundoNombreVacuna');
    const inputSexoVacuna = document.getElementById('inputSexoVacuna');
    const inputNumArchivoVacuna = document.getElementById('inputNumArchivoVacuna');

    // Agregar evento al modal cuando se muestra
    $('#modalInfoPaciente').on('shown.bs.modal', function () {
      inputRucVacuna.value = '';
      inputNombreEmpresaVacuna.value = '';
      inputNumHistoriaClinicaVacuna.value = '';
      inputCargoOcupacionVacuna.value = '';
      inputPrimerApellidoVacuna.value = '';
      inputSegundoApellidoVacuna.value = '';
      inputPrimerNombreVacuna.value = '';
      inputSegundoNombreVacuna.value = '';
      inputNumArchivoVacuna.value = '';

      Swal.fire({
        position: "top-end",
        icon: "info",
        title: "Cargando información ...",
        showConfirmButton: false,
      });

      var codprovcli = $('#codigo_paciente').val();

      // Verifica si hay un valor de codprovcli antes de realizar la solicitud AJAX
      if (codprovcli) {
        // Construye la URL completa con el parámetro codprovcli
        var url = `/empresa/Hormi2023/fichasii4?codprovcli=${codprovcli}`;

        // Realiza la solicitud AJAX para obtener los detalles del paciente
        $.ajax({
          type: 'GET',
          url: url,
          success: function (data) {
            if (data.error) {
              Swal.fire({
                position: "top-end",
                icon: "error",
                title: `${data.error}`,
                showConfirmButton: false,
              });
            } else {
              Swal.close();
              // LLENAR INPUT CON DATA

              let empresa = data.empresa;
              inputRucVacuna.value = empresa.Ruc
              inputNombreEmpresaVacuna.value = empresa.Nombreempresa
              inputNumHistoriaClinicaVacuna.value = empresa.HistoriaClinica
              inputCargoOcupacionVacuna.value = empresa.Ocupacion
              inputPrimerApellidoVacuna.value = empresa.PrimerApellido;
              inputSegundoApellidoVacuna.value = empresa.SegundoApellido;
              inputPrimerNombreVacuna.value = empresa.PrimerNombre;
              inputSegundoNombreVacuna.value = empresa.SegundoNombre;
              inputSexoVacuna.value = empresa.Sexo;
              inputNumArchivoVacuna.value = empresa.NumeroArchivo;
              // DATOS LLENOS
              Swal.fire({
                position: "top-end",
                icon: "success",
                title: `Datos llenos correctamente`,
                showConfirmButton: false,
                timer: 1000,
              });


              $('#btnGrabar').on('click', function () {
                  if (datosTetanos.length > 0) {
            // Actualiza la variable 'empresa' con los datos del paciente
            empresa = {
                'Nombreempresa': inputNombreEmpresaVacuna.value,
                'Ruc': inputRucVacuna.value,
                'HistoriaClinica': inputNumHistoriaClinicaVacuna.value,
                'PrimerApellido': inputPrimerApellidoVacuna.value,
                'SegundoApellido': inputSegundoApellidoVacuna.value,
                'PrimerNombre': inputPrimerNombreVacuna.value,
                'SegundoNombre': inputSegundoNombreVacuna.value,
                'Sexo': inputSexoVacuna.value,
                'Ocupacion': inputCargoOcupacionVacuna.value
                // Agrega más campos según sea necesario
            };

            // Enviar el valor a la vista usando Ajax
            enviarDatos(empresa);
            empresa = {}; // Puedes reiniciar la variable 'empresa' si es necesario
        }

                });
            }
          },
          error: function () {
            alert('Error al obtener los detalles del paciente');
          }
        });
      }
    });
  });


</script>

<!-- CODIGO PARA LA FUNCIONALIDAD DE LA TABLA -->
<script>
  let datosTetanos = [];
  var contadorDosis = 1;
  const inputObservaciones = document.getElementById('observacionesInput');
  // Restablecer los valores de la tabla

  function agregarFila() {
    // Obtén los valores de los campos de entrada
    const fecha = document.getElementById('fechaInput').value;
    const lote = document.getElementById('loteInput').value;
    const esquema = document.getElementById('esquemaInput').checked;
    const responsable = document.getElementById('responsableInput').value;
    const establecimiento = document.getElementById('establecimientoInput').value;
    const observaciones = document.getElementById('observacionesInput').value;
    const dosisSpan = document.getElementById('dosisSpan');
    const btnAgregarFilaTetanos = document.getElementById('btnAgregarFilaTetanos');
    var hayDatosEnTabla = datosTetanos.length > 0;
     var vacuna_tetano = hayDatosEnTabla ? 'Recibida' : '';
    if (fecha, lote, responsable, establecimiento != '') {
      var nuevaFila = {
        dosis: contadorDosis,
        fecha: fecha,
        lote: lote,
        esquema: esquema,
        responsable: responsable,
        establecimiento: establecimiento,
        observaciones: observaciones
      };
      datosTetanos.push(nuevaFila);
      // Obtén el cuerpo de la tabla
      const tbody = document.getElementById('tableTetanos').getElementsByTagName('tbody')[0];
      // Crea una nueva fila
      const newRow = tbody.insertRow();
      // Agrega celdas a la nueva fila
      const cell1 = newRow.insertCell(0);
      const cell2 = newRow.insertCell(1);
      const cell3 = newRow.insertCell(2);
      const cell4 = newRow.insertCell(3);
      const cell5 = newRow.insertCell(4);
      const cell6 = newRow.insertCell(5);
      const cell7 = newRow.insertCell(6);
      const cell8 = newRow.insertCell(7);
      // Llena las celdas con los valores de los campos de entrada
      cell1.innerHTML = '+';
      cell2.innerHTML = contadorDosis;
      cell3.innerHTML = fecha;
      cell4.innerHTML = lote;
      cell5.innerHTML = esquema ? 'Sí' : 'No';
      cell6.innerHTML = responsable;
      cell7.innerHTML = establecimiento;
      cell8.innerHTML = observaciones;
      // Incrementar el contador de dosis
      contadorDosis++;

      // Limpia o convierte los campos de entrada en etiquetas, según tu necesidad
      dosisSpan.value = contadorDosis;
      dosisSpan.textContent = contadorDosis;
      document.getElementById('fechaInput').value = '';
      document.getElementById('loteInput').value = '';
      document.getElementById('esquemaInput').checked = false;
      document.getElementById('responsableInput').value = '';
      document.getElementById('establecimientoInput').value = '';
      document.getElementById('observacionesInput').value = '';
      // Verificar si el contador de dosis llega a 5 y deshabilitar el botón
      if (contadorDosis > 5) {
        btnAgregarFilaTetanos.disabled = true;
        document.getElementById('fechaInput').disabled = true;
        document.getElementById('loteInput').disabled = true;
        document.getElementById('responsableInput').disabled = true;
        document.getElementById('esquemaInput').disabled = true;
        document.getElementById('establecimientoInput').disabled = true;
        document.getElementById('observacionesInput').disabled = true;

      }
    } else {
      Swal.fire({
        position: "top-end",
        icon: "error",
        title: "Por favor llene los datos necesarios!",
        showConfirmButton: false,
        timer: 2000
      });
    }


  }

  // FUNCIONAMIENTO DEL ENTER
  inputObservaciones.addEventListener('keydown', function () {
    if (event.key === 'Enter') {
      event.preventDefault();
      agregarFila();
    }
  })


</script>






{% endblock %}